# XY扰动功能说明

## 功能概述
为Railway Controller系统添加了XY方向的扰动功能，用于模拟实际工程中腿子在下降过程中可能遇到的位置扰动。

## 实现特点

### 1. 统一扰动
- 所有12个腿子使用相同的XY扰动参数
- 扰动方向一致，模拟整体系统性偏移
- 保持腿子之间的相对位置关系

### 2. 扰动模型
- **X方向扰动**：主频正弦波 + 高频微小波动
  ```
  dx = A × sin(2πft) + 0.3A × sin(2π×3ft)
  ```
- **Y方向扰动**：不同相位和频率的余弦波组合
  ```
  dy = 0.8A × cos(2π×0.7ft + π/3) + 0.2A × cos(2π×2.5ft)
  ```

### 3. 参数配置
- **扰动幅度（amplitude）**：控制扰动的最大偏移量（mm）
- **扰动频率（frequency）**：控制扰动变化的快慢（Hz）
- **启用开关**：可以完全关闭扰动功能

## 使用方法

### 1. 命令行参数
启动模拟设备时可以配置扰动参数：
```bash
python -m hardware.mock_serial_device --ctrl-port COM1 --telem-port COM3 --xy-disturbance --disturbance-amplitude 3.0 --disturbance-frequency 0.3
```

参数说明：
- `--xy-disturbance`：启用XY扰动功能
- `--disturbance-amplitude 3.0`：设置扰动幅度为3.0mm
- `--disturbance-frequency 0.3`：设置扰动频率为0.3Hz

### 2. 一键启动脚本
使用 `start_with_xy_disturbance.bat` 脚本可以一键启动带扰动的完整系统：
```
start_with_xy_disturbance.bat
```

默认配置：
- 扰动幅度：3.0mm
- 扰动频率：0.3Hz
- 控制端口：COM1
- 遥测端口：COM3

### 3. 代码集成
扰动功能直接融合在 `mock_serial_device.py` 中：
- 在遥测循环中实时计算扰动值
- 应用到所有腿子的基础坐标上
- 通过遥测数据发送给上位机

## 扰动效果

### 1. 实时特性
- 扰动值每100ms更新一次（与遥测频率一致）
- 平滑连续的变化，避免突变
- 符合实际工程中的扰动特征

### 2. 几何中心影响
- 由于所有腿子同步扰动，几何中心也会相应移动
- 上位机的几何中心估计算法会实时跟踪这些变化
- 可以验证控制系统对扰动的响应能力

### 3. 控制系统测试
- 测试几何中心估计的稳定性
- 验证EMA滤波的效果
- 评估控制系统的抗扰动能力

## 参数建议

### 不同测试场景的推荐参数：

1. **轻微扰动测试**
   - 幅度：1.0-2.0mm
   - 频率：0.1-0.2Hz
   - 用途：日常系统验证

2. **中等扰动测试**
   - 幅度：3.0-5.0mm
   - 频率：0.3-0.5Hz
   - 用途：系统鲁棒性测试

3. **强扰动测试**
   - 幅度：5.0-10.0mm
   - 频率：0.5-1.0Hz
   - 用途：极限条件测试

## 注意事项

1. **扰动基准**：扰动是基于固定的腿子坐标计算的，不会累积
2. **急停处理**：急停状态下扰动仍然会继续（模拟真实环境）
3. **端口兼容**：单端口模式下扰动功能同样有效
4. **性能影响**：扰动计算开销很小，不会影响系统性能
