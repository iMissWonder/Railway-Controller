# 几何中心X坐标计算逻辑修复

## 问题分析

### 原始问题
GUI中显示的"当前几何中心"X值是固定的（1143.9），不会随着腿子位置变化而变化，这与预期的动态计算逻辑不符。

### 根本原因
1. **Mock模式问题**：在mock模式下，腿子的XY坐标是固定值，没有扰动
2. **扰动设计问题**：原始扰动算法对所有腿子施加相同的XY偏移，导致腿对间的相对位置差值(ΔY)保持不变
3. **计算逻辑正确**：X坐标计算公式 `Xc = (Δy/2) / tan_12` 本身是正确的

## 解决方案

### 1. 修改扰动算法
为每个腿子引入轻微的个体差异：
- **相位差异**：每个腿子有0.1弧度的相位偏移
- **幅度差异**：±10%的幅度变化
- **独立扰动**：每个腿子的扰动略有不同

### 2. 修改后的扰动公式
```python
# 个体差异参数
leg_phase_offset = leg_index * 0.1  # 相位差
leg_amplitude_factor = 1.0 + (leg_index % 3 - 1) * 0.1  # 幅度系数

# X方向扰动（带个体差异）
dx = amplitude * leg_amplitude_factor * sin(2πft + φ) + 0.3 * amplitude * sin(6πft + φ)

# Y方向扰动（带个体差异）  
dy = 0.8 * amplitude * leg_amplitude_factor * cos(1.4πft + π/3 + φ) + 0.2 * amplitude * cos(5πft + φ)
```

### 3. 效果验证
修改后的扰动效果：

| 时间(s) | 腿1Y扰动 | 腿2Y扰动 | 腿1Y坐标 | 腿2Y坐标 | ΔY变化 | X坐标变化 |
|---------|----------|----------|----------|----------|--------|-----------|
| 0.0     | 1.68     | 1.58     | 1.7      | 173.3    | 171.60 | 1143.3    |
| 2.0     | -2.45    | -2.52    | -2.4     | 169.2    | 171.63 | 1143.5    |
| 4.0     | 2.76     | 2.97     | 2.8      | 174.7    | 171.91 | 1145.3    |
| 6.0     | -2.53    | -2.84    | -2.5     | 168.9    | 171.39 | 1141.9    |

**✅ 现在X坐标会在1141.9~1146.1范围内动态变化！**

## 技术细节

### 修改的文件
- `hardware/mock_serial_device.py`：修改 `_calculate_xy_disturbance()` 和 `_update_xy_positions_with_disturbance()` 方法

### 核心改进
1. **个体化扰动**：每个腿子根据索引计算独特的扰动值
2. **保持真实性**：扰动仍然具有工程实际的特征（低频、平滑）
3. **可控变化**：X坐标变化范围合理，不会产生异常值

### 计算逻辑验证
- 腿对(1,2)的Y值差异：ΔY = y2 - y1
- X坐标计算：Xc = (ΔY/2) / tan_12
- tan_12 = (tan1 + tan2) / 2 = 0.075050
- 当ΔY从171.39变化到171.91时，X坐标从1141.9变化到1145.3

## 使用效果

### GUI中的表现
- **当前几何中心X值**：现在会随时间动态变化
- **变化范围**：通常在±5mm范围内波动
- **变化频率**：跟随扰动频率（默认0.3Hz）

### 系统验证方法
1. 启动带扰动的系统：`start_with_xy_disturbance.bat`
2. 观察GUI中"当前几何中心"的X值
3. 确认X值随时间变化，不再是固定值

### 测试建议
- **轻微扰动**：幅度1-2mm，观察细微变化
- **中等扰动**：幅度3-5mm，观察明显变化
- **频率测试**：调整0.1-1.0Hz，观察变化速度

现在系统的几何中心X坐标计算已经能够正确响应腿子位置的动态变化！
